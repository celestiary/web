import{Asterisms,HelpButton,INITIAL_FOV,Keys,LENGTH_SCALE,Loader,Measure,Object3D,Planet,Raycaster,SpriteSheet,Star,StarSpectra,Stars,ThreeUi,Time,Vector2,Vector3,assertArgs,capitalize,createTree,elt,makeCollapsable,marker,queryPoints,reifyMeasures,setTitleFromLocation,shapes_exports,shared_exports,targets,three_module_exports,twoPi,utils_exports,visitToggleProperty}from"./chunk-XEYVNUBX.js";import{Link,__toESM,require_jsx_runtime,require_react,useLocation}from"./chunk-FJCDU6YP.js";var import_react3=__toESM(require_react(),1);var import_react=__toESM(require_react(),1);var import_jsx_runtime=__toESM(require_jsx_runtime(),1);function AboutButton(){let[open,setOpen]=import_react.default.useState(!1),toggleOpen=()=>{setOpen(!open)};return(0,import_jsx_runtime.jsxs)(import_jsx_runtime.Fragment,{children:[(0,import_jsx_runtime.jsx)("button",{onClick:toggleOpen,className:"textButton",children:"About"}),open&&(0,import_jsx_runtime.jsx)(About,{openToggle:toggleOpen})]})}function About({openToggle}){return(0,import_jsx_runtime.jsxs)("div",{className:"dialog",children:[(0,import_jsx_runtime.jsx)("button",{onClick:openToggle,children:"X"}),(0,import_jsx_runtime.jsx)("h1",{children:"About"}),"Celestiary is a cosmological simulator.",(0,import_jsx_runtime.jsx)("h2",{children:"News"}),(0,import_jsx_runtime.jsxs)("ul",{children:[(0,import_jsx_runtime.jsx)("li",{children:"2021 Dec 30 - Introduce esbuild with code splitting.  Use react and react-router to improve code structure and prepare for better permalinks."}),(0,import_jsx_runtime.jsx)("li",{children:"2021 Jan 25 - Works in Safari 13.1.2+ on OSX, maybe earlier. Now all major browsers tested except IE."})]}),(0,import_jsx_runtime.jsx)("h2",{children:"Features"}),(0,import_jsx_runtime.jsxs)("ul",{children:[(0,import_jsx_runtime.jsx)("li",{children:"Keplerian orbits (6 orbital elements)"}),(0,import_jsx_runtime.jsx)("li",{children:"Time controls, to alter rate and direction of time"}),(0,import_jsx_runtime.jsx)("li",{children:"Star colors based on surface temperatures"}),(0,import_jsx_runtime.jsx)("li",{children:"Star surface dynamics simulation (Perlin noise in black-body spectra)"}),(0,import_jsx_runtime.jsx)("li",{children:"9 planets, 20 moons"}),(0,import_jsx_runtime.jsx)("li",{children:"Permanent links for scene locations"}),(0,import_jsx_runtime.jsx)("li",{children:"Even kinda works on mobile! :)"})]}),(0,import_jsx_runtime.jsx)("h2",{children:"Datasets"}),(0,import_jsx_runtime.jsxs)("ul",{children:[(0,import_jsx_runtime.jsx)("li",{children:"~100,000 stars"}),(0,import_jsx_runtime.jsx)("li",{children:"~3k star names"}),(0,import_jsx_runtime.jsx)("li",{children:"~80 Asterisms/constellations"})]}),(0,import_jsx_runtime.jsx)("h2",{children:"Learn more"}),(0,import_jsx_runtime.jsxs)("ul",{children:[(0,import_jsx_runtime.jsx)("li",{children:(0,import_jsx_runtime.jsx)(Link,{to:"/guide",children:"Software development guide"})}),(0,import_jsx_runtime.jsx)("li",{children:(0,import_jsx_runtime.jsx)("a",{href:"https://github.com/pablo-mayrgundter/celestiary",target:"_blank",rel:"noreferrer",children:"Source code (GitHub)"})})]})]})}var Animation=class{constructor(time){this.time=time,this.Y_AXIS=new Vector3(0,1,0)}animate(scene){this.time.updateTime(),this.animateSystem(scene,this.time.simTime/1e3)}animateSystem(system,simTimeSecs){if(system.preAnimCb&&system.preAnimCb(this.time),system.siderealRotationPeriod){let angle=1.5*Math.PI+simTimeSecs/86400*twoPi;system.setRotationFromAxisAngle(this.Y_AXIS,angle)}if(system.orbit){let eccentricity=system.orbit.eccentricity,aRadius=system.orbit.semiMajorAxis.scalar*LENGTH_SCALE,bRadius=aRadius*Math.sqrt(1-Math.pow(eccentricity,2)),angle=-1*simTimeSecs/system.orbit.siderealOrbitPeriod.scalar*twoPi,x=aRadius*Math.cos(angle),y=0,z=bRadius*Math.sin(angle);system.position.set(x,y,z),system.postAnimCb&&system.postAnimCb(system)}for(let ndx in system.children){if(!Object.prototype.hasOwnProperty.call(ndx,system.children))continue;let child=system.children[ndx];this.animateSystem(child,simTimeSecs)}}};var ControlPanel=class{constructor(containerElt,loader){this.containerElt=containerElt,this.loader=loader}getPathTarget(path){return path[path.length-1]}showNavDisplay(path){let crumbs="";for(let i=0;i<path.length;i++){let hash=path.slice(0,i+1).join("/"),name=path[i];i===path.length-1?crumbs+=capitalize(name):crumbs+=`<a href="#${hash}">${capitalize(name)}</a>`,i<path.length-1&&(crumbs+=" &gt; ")}let html=`${crumbs} <ul>
`,pathPrefix=path.join("/");html+=this.showInfoRecursive(this.loader.loaded[this.getPathTarget(path)],pathPrefix,!1,!1),html+=`</ul>
`,this.containerElt.innerHTML=html,makeCollapsable(this.containerElt)}showInfoRecursive(obj,pathPrefix,isArray,isSystem){function cleanZeros(num){return`${num}`.replace(/0000+\d+/," ")}let html="";for(let prop in obj)if(!(prop==="name"||prop==="parent"||prop.startsWith("texture_")||prop==="apparentMagnitude"||prop==="colorIndex")&&Object.prototype.hasOwnProperty.call(prop,obj)){let val=obj[prop];if(prop==="system"&&typeof val=="object"&&Array.isArray(val)&&val.length===0)continue;if(html+="<li>",!isArray){let prettyName=prop;switch(prop){case"axialInclination":prettyName="tilt";break;case"siderealRotationPeriod":prettyName="rotation period";break;case"spectralType":prettyName="star class";break;default:}html+=`${prettyName}: `}if(val instanceof Measure){switch(prop){case"radius":val=val.convertTo(Measure.Magnitude.KILO);break;case"mass":val=val.convertTo(Measure.Magnitude.KILO);break;case"semiMajorAxis":typeof val.scalar=="string"&&(val.scalar=parseFloat(val.scalar)),val.scalar=val.scalar.toExponential(4),val=val.toString();break;case"siderealOrbitPeriod":val=secsToYDHMS(val.scalar);break;case"siderealRotationPeriod":val=secsToYDHMS(val.scalar);break;default:}html+=cleanZeros(val)}else if(val instanceof Array)prop==="system"?html+=`<ol>
`:html+=`<ol class="collapsed">
`,html+=this.showInfoRecursive(val,pathPrefix,!0,prop==="system"),html+=`</ol>
`;else if(val instanceof Object)html+=`<ul class="collapsed">
`,html+=this.showInfoRecursive(val,pathPrefix,!1,!1),html+=`</ul>
`;else{if(isSystem){let path=pathPrefix;pathPrefix.length>0&&(path+="/"),path+=val,html+=`<a href="#${path}">`,html+=capitalize(val)}else{switch(prop){case"spectralType":{let ndx=parseInt(val);ndx>=0&&(val=StarSpectra[ndx][3]);break}case"equatorialGravity":case"escapeVelocity":{val=`${val} m/s^2`;break}case"axialInclination":val=`${val}\xB0`;break;default:}html+=val}isSystem&&(html+="</a>")}html+=`</li>
`}return html=html.replaceAll("^2","\xB2"),html=html.replaceAll("^3","\xB3"),html}};function secsToYDHMS(s){let str="",years=parseInt(s/31536e3);years>0&&(s-=years*31536e3,str+=`${years}y`);let days=parseInt(s/86400);days>0&&(s-=days*86400,str+=` ${days}d`);let hours=parseInt(s/3600);hours>0&&(s-=hours*3600,str+=` ${hours}h`);let minutes=parseInt(s/60);minutes>0&&(s-=minutes*60,str+=` ${minutes}m`);let seconds=parseInt(s);return seconds>0&&(str+=` ${seconds}s`),str}var lengthScale=LENGTH_SCALE,INITIAL_STEP_BACK_MULT=10,Scene=class{constructor(ui){this.ui=ui,this.objects={},this.mouse=new Vector2,this.raycaster=new Raycaster,this.raycaster.params.Points.threshold=3,ui.addClickCb(click=>{this.onClick(click)}),this.stars=null,this.asterisms=null,this.marker=marker(),this.marker.visible=!0,this.ui.scene.add(this.marker),this.starSelected=!1}add(props){let name=props.name,parentObj=this.objects[props.parent],parentOrbitPosition=this.objects[`${props.parent}.orbitPosition`];if((props.name==="milkyway"||props.name==="sun")&&(parentObj=parentOrbitPosition=this.ui.scene),!parentObj||!parentOrbitPosition)throw new Error(`No parent obj: ${parentObj} or pos: ${parentOrbitPosition} for ${name}`);let obj3d=this.objectFactory(props);return parentOrbitPosition.add(obj3d),obj3d}objectFactory(props){let pickedStarLabel;switch(props.type){case"galaxy":return this.newGalaxy(props);case"stars":return this.stars=new Stars(props,()=>{this.stars.showLabels();let tree=createTree();tree.init(this.stars.geom.coords);let traceCb=e=>{queryPoints(this.ui,e,tree,this.stars,pick=>{this.starSelected||this.marker.position.copy(pick),pickedStarLabel!==null&&pickedStarLabel.removeFromParent();let starName=`${this.stars.catalog.getNameOrId(pick.star.hipId)}`,pickedLabelSheet=new SpriteSheet(1,starName,void 0,[0,1e5]);pickedLabelSheet.add(pick.x,pick.y,pick.z,starName),pickedStarLabel=pickedLabelSheet.compile(),this.ui.scene.add(pickedStarLabel)})},markCb=e=>{queryPoints(this.ui,e,tree,this.stars,pick=>{this.starSelected&&this.marker.position.copy(pick),this.starSelected=!this.starSelected})};document.body.addEventListener("dblclick",markCb),document.body.addEventListener("mousemove",traceCb)}),console.log("this.stars",this.stars),this.stars;case"star":return new Star(props,this.objects,this.ui);case"planet":return new Planet(this,props);case"moon":return new Planet(this,props,!0);default:}throw new Error(`Object has unknown type: ${props.type}`)}newObject(name,props,onClick){let obj=this.newGroup(name,props);if(!onClick)throw new Error("Must provide an onClick handler");return obj.onClick=onClick,obj}newGroup(name,props){let obj=new Object3D;return this.objects[name]=obj,obj.name=name,props&&(obj.props=props),obj}targetNamed(name){this.setTarget(name),this.lookAtTarget()}targetParent(){let cObj=targets.cur;cObj&&cObj.props&&cObj.props.parent&&this.setTarget(cObj.props.parent)}targetNode(index){let cObj=targets.cur;if(cObj&&cObj.props&&cObj.props.system&&cObj.props.system){let sys=cObj.props.system;sys[index-1]&&this.setTarget(sys[index-1])}}targetCurNode(){let cObj=targets.cur;cObj&&cObj.props&&cObj.props.name&&this.setTarget(cObj.props.name)}setTarget(name){let obj=this.objects[name];if(!obj)throw new Error(`scene#setTarget: no matching target: ${name}`);targets.obj=obj}lookAtTarget(){if(!targets.obj){console.error("scene.js#lookAtTarget: no target obj to look at.");return}let obj=targets.obj,tPos=targets.pos;this.ui.scene.updateMatrixWorld(),tPos.setFromMatrixPosition(obj.matrixWorld),this.ui.camera.lookAt(tPos)}goTo(){if(!targets.obj){console.error("Scene.goTo called with no target obj.");return}let obj=targets.obj,tPos=targets.pos;this.ui.scene.updateMatrixWorld(),tPos.setFromMatrixPosition(obj.matrixWorld);let pPos=new Vector3,cPos=new Vector3,surfaceAltitude=obj.props.radius.scalar*lengthScale;pPos.set(0,0,0),cPos.set(0,0,surfaceAltitude*INITIAL_STEP_BACK_MULT),obj.orbitPosition.add(this.ui.camera.platform),this.ui.camera.platform.position.copy(pPos),this.ui.camera.platform.lookAt(targets.origin),this.ui.camera.position.copy(cPos),this.ui.camera.lookAt(tPos),targets.track=targets.cur=targets.obj,this.ui.controls.update()}track(name){targets.track?targets.track=null:targets.track=targets.obj}follow(name){if(targets.follow)delete targets.follow.postAnimCb,targets.follow=null;else if(targets.obj)if(targets.obj.orbitPosition){let followed=targets.obj.orbitPosition;targets.follow=followed,followed.postAnimCb=obj=>{this.ui.camera.platform.lookAt(targets.origin)},followed.postAnimCb(followed)}else console.error("Target to follow has no orbitPosition property.");else console.error("No target object to follow.")}onClick(mouse){this.ui.scene.updateMatrixWorld(),this.raycaster.setFromCamera(mouse,this.ui.camera);let t=Date.now(),intersects=this.raycaster.intersectObjects(this.ui.scene.children,!0),elapsedSeconds=(Date.now()-t)/1e3;if(elapsedSeconds>.1&&console.error("Scene picking taking a long time (seconds): ",elapsedSeconds),intersects.length===0)return;let nearestMeshIntersect,nearestPointIntersect,nearestStarPointIntersect,nearestDefaultIntersect;for(let i=0;i<intersects.length;i++){let intersect=intersects[i],dist=intersect.distance,obj2=intersect.object;if(obj2.isAnchor){console.log("raycast skipping anchor");continue}if(obj2.type!=="Line")switch(obj2.type){case"Mesh":{if(nearestMeshIntersect&&nearestMeshIntersect.distance<dist)continue;nearestMeshIntersect=intersect;break}case"Points":{if(obj2.isStarPoints){if(nearestStarPointIntersect&&nearestStarPointIntersect.distanceToRay<intersect.distanceToRay)continue;nearestStarPointIntersect=intersect}else{if(nearestPointIntersect&&nearestPointIntersect.distance<dist)continue;nearestPointIntersect=intersect}break}default:{if(nearestDefaultIntersect&&nearestDefaultIntersect.distance<dist)continue;nearestDefaultIntersect=intersect}}}let nearestIntersect=nearestMeshIntersect||nearestPointIntersect||nearestStarPointIntersect||nearestDefaultIntersect||null;if(!nearestIntersect)throw new Error("Picking did not yield an intersect.  Intersects: ",intersects);let obj=nearestIntersect.object,firstName;do{if((obj.name||obj.props&&obj.props.name&&!firstName)&&(firstName=obj.name||obj.props&&obj.props.name),obj.onClick){obj.onClick(mouse,nearestIntersect,obj);break}if(obj===obj.parent){console.error("no clickable object found in path to root.");break}}while(obj=obj.parent)}toggleAsterisms(){if(this.asterisms===null){let asterisms=new Asterisms(this.stars,()=>{this.stars.add(asterisms),console.log("Asterisms count:",asterisms.catalog.numAsterisms),this.asterisms=asterisms})}this.asterisms&&(this.asterisms.visible=!this.asterisms.visible)}toggleOrbits(){visitToggleProperty(this.objects.sun,"name","orbit","visible")}togglePlanetLabels(){visitToggleProperty(this.objects.sun,"name","label","visible")}toggleStarLabels(){this.stars.labelLOD.visible=!this.stars.labelLOD.visible}newGalaxy(galaxyProps){let group=this.newObject(galaxyProps.name,galaxyProps,click=>{});return this.objects[`${galaxyProps.name}.orbitPosition`]=group,group}};var DEFAULT_TARGET="sun",elt2=id=>document.getElementById(id),Celestiary=class{constructor(canvasContainer,navElt,setTimeStr){assertArgs(arguments,3),this.time=new Time(setTimeStr),this.animation=new Animation(this.time),canvasContainer.style.width=`${window.innerWidth}px`,canvasContainer.style.height=`${window.innerHeight}px`;let animCb=scene=>{this.animation.animate(scene),targets.track&&this.scene.lookAtTarget()};this.ui=new ThreeUi(canvasContainer,animCb),this.scene=new Scene(this.ui),this.loader=new Loader,this.controlPanel=new ControlPanel(navElt,this.loader),this.load(),this.setupListeners(),this.navVisible=!0,this.shared=shared_exports,this.shapes=shapes_exports,this.three=three_module_exports,this.utils=utils_exports,this.toggleHelp=null,window.c=this}getTime(){if(this.time===null)throw new Error("Null time");return this.time}load(){this.onLoadCb=(name,obj)=>{reifyMeasures(obj),this.scene.add(obj)},this.onDoneCb=(path2,obj)=>{this.controlPanel.showNavDisplay(path2.split("/"),this.loader),setTimeout(()=>{let parts=path2.split("/"),targetName=parts[parts.length-1];targetName.indexOf("-")>=0&&(targetName=targetName.split("-")[0]),this.scene.targetNamed(targetName),this.scene.goTo()},0)};let path;location.hash?path=location.hash.substring(1):(path=DEFAULT_TARGET,location.hash=path),this.loader.loadPath("milkyway",this.onLoadCb,()=>{this.loader.loadPath(path,this.onLoadCb,this.onDoneCb,()=>{setTimeout(()=>{location.hash=DEFAULT_TARGET},1e3)})})}goTo(){let tObj=this.shared.targets.obj;if(tObj)if(tObj.props&&tObj.props.name){let path=this.loader.pathByName[tObj.props.name];path?window.location.hash=path:console.error(`no loaded path for ${tObj.props.name}: ${path}`)}else console.error("target obj has no name prop: ",tObj);else console.error("no target obj!")}setupListeners(){window.addEventListener("hashchange",e=>{this.loader.loadPath((window.location.hash||"#").substring(1),this.onLoadCb,this.onDoneCb)},!1);let k=new Keys;k.map("Escape",()=>{this.hideActiveDialog()},"Hide active dialog"),k.map(" ",()=>{this.time.togglePause()},"Toggle time pause"),k.map(",",()=>{this.ui.multFov(.9)},"Narrow field-of-vision"),k.map(".",()=>{this.ui.multFov(1.1)},"Broaden field-of-vision"),k.map("/",()=>{this.ui.resetFov()},`Reset field-of-vision to ${INITIAL_FOV}\xBA`),k.map("0",()=>{this.scene.targetCurNode()},"Target current system");for(let i=1;i<=9;i++)k.map(`${i}`,()=>{let ndx=i;this.scene.targetNode(ndx)},`Look at child ${i} of current system`);k.map(";",()=>{this.time.changeTimeScale(0)},"Change time scale to real-time"),k.map("c",()=>{this.scene.lookAtTarget()},"Look at target"),k.map("f",()=>{this.scene.follow()},"Follow current node"),k.map("g",()=>{this.goTo()},"Go to target node"),k.map("j",()=>{this.time.invertTimeScale()},"Reverse time"),k.map("k",()=>{this.time.changeTimeScale(-1)},"Slow down time"),k.map("l",()=>{this.time.changeTimeScale(1)},"Speed up time"),k.map("n",()=>{this.time.setTimeToNow()},"Set time to now"),k.map("t",()=>{this.scene.track()},"Track target node"),k.map("u",()=>{this.scene.targetParent()},"Look at parent of current system"),k.map("A",()=>{this.scene.toggleAsterisms()},"Show/hide asterisms"),k.map("O",()=>{this.scene.toggleOrbits()},"Show/hide orbits"),k.map("P",()=>{this.scene.togglePlanetLabels()},"Show/hide planet and moon names"),k.map("S",()=>{this.scene.toggleStarLabels()},"Show/hide star names"),k.map("V",()=>{[elt2("nav-id"),elt2("top-right")].map(panel=>{panel.style.visibility=this.navVisible?"hidden":"visible"}),this.navVisible=!this.navVisible},"Show/hide navigation panels"),this.keys=k}hideActiveDialog(){document.querySelectorAll(".dialog").forEach(e=>this.hideElt(e))}hideElt(e){e.style.display="none"}toggleEltDisplay(e){return e.style.display==="block"?(this.hideElt(elt2),!1):(this.hideActiveDialog(),e.style.display="block",!0)}hideHelpOnEscape(){let keysElt=elt2("keys-id");keysElt.style.display="none"}};var import_react2=__toESM(require_react(),1),import_jsx_runtime2=__toESM(require_jsx_runtime(),1);function updateTimeMsg(time){let msg="";return time.timeScale==1?msg="real-time":msg=time.timeScale.toLocaleString()+" secs/s",time.pause&&(msg+=" (paused)"),msg}function TimePanel({time,timeStr}){let[timeScale,setTimeScale]=import_react2.default.useState("");return import_react2.default.useEffect(()=>{setTimeScale(updateTimeMsg(time))},[timeStr]),(0,import_jsx_runtime2.jsxs)("div",{id:"time-id",children:[(0,import_jsx_runtime2.jsx)("div",{id:"date-id",children:timeStr}),(0,import_jsx_runtime2.jsx)("div",{id:"time-scale-id",children:timeScale}),(0,import_jsx_runtime2.jsxs)("div",{id:"time-controls-id",children:[(0,import_jsx_runtime2.jsx)("button",{onClick:()=>{time.changeTimeScale(1)},children:"+"}),(0,import_jsx_runtime2.jsx)("button",{onClick:()=>{time.changeTimeScale(-1)},children:"-"}),(0,import_jsx_runtime2.jsx)("button",{onClick:()=>{time.changeTimeScale(0)},children:"="}),(0,import_jsx_runtime2.jsx)("button",{onClick:()=>{time.invertTimeScale()},children:"/"})]})]})}var import_jsx_runtime3=__toESM(require_jsx_runtime(),1);function App(){let location2=useLocation();import_react3.default.useEffect(()=>{setTitleFromLocation(location2)},[location2]);let[celestiary,setCelestiary]=import_react3.default.useState(null),[timeStr,setTimeStr]=import_react3.default.useState(""),[showAbout,setShowAbout]=import_react3.default.useState(!1);return import_react3.default.useEffect(()=>{setCelestiary(new Celestiary(elt("scene-id"),elt("nav-id"),setTimeStr))},[]),(0,import_jsx_runtime3.jsxs)(import_jsx_runtime3.Fragment,{children:[(0,import_jsx_runtime3.jsx)("div",{id:"scene-id"}),(0,import_jsx_runtime3.jsx)("div",{id:"nav-id",className:"panel",children:"Welcome to Celestiary!  Loading..."}),(0,import_jsx_runtime3.jsxs)("div",{id:"top-right",className:"panel",children:[celestiary&&(0,import_jsx_runtime3.jsx)(TimePanel,{time:celestiary.time,timeStr}),(0,import_jsx_runtime3.jsxs)("div",{id:"text-buttons",children:[celestiary&&(0,import_jsx_runtime3.jsx)(HelpButton,{keys:celestiary.keys}),(0,import_jsx_runtime3.jsx)(AboutButton,{})]})]}),(0,import_jsx_runtime3.jsx)("h1",{id:"target-id"})]})}export{App as default};
//# sourceMappingURL=App-4IJV6GF5.js.map
